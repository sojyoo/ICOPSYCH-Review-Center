// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  studentNumber String?  @unique
  name          String?
  password      String?
  role          String   @default("student") // student, admin
  cohortId      String?
  cohort        String?  @default("ICOPSYCH-2025") // ICOPSYCH-2025, etc.
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cohortRelation Cohort?       @relation(fields: [cohortId], references: [id])
  testAttempts   TestAttempt[]

  @@map("users")
}

model Cohort {
  id          String    @id @default(cuid())
  name        String    @unique // ICOPSYCH-2025
  description String?
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  users User[]

  @@map("cohorts")
}

model Question {
  id           String   @id @default(cuid())
  question     String
  options      String // JSON array of options
  correctIndex Int
  subject      String
  difficulty   String   @default("medium") // easy, medium, hard
  lecture      Int // 1, 2, 3
  week         Int // Week number
  explanation  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  attempts         QuestionAttempt[]
  questionConcepts QuestionConcept[]

  @@map("questions")
}

model Test {
  id             String   @id @default(cuid())
  title          String
  description    String?
  type           String // pre-test, post-test, mock-exam
  weekNumber     Int?
  lecture        Int?
  subjects       String? // JSON array of subjects
  timeLimit      Int? // in minutes
  totalQuestions Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  attempts TestAttempt[]

  @@map("tests")
}

model TestAttempt {
  id             String    @id @default(cuid())
  userId         String
  testId         String?
  testType       String // pre-test, post-test, mock-exam
  weekNumber     Int? // Week number for schedule-based tests
  lecture        Int? // Lecture number (1, 2, 3)
  subjects       String? // JSON string of subjects for this test
  score          Int // Total correct answers
  totalQuestions Int // Total questions
  timeSpent      Int // Time spent in seconds
  subjectScores  String? // JSON string of subject scores
  completedAt    DateTime? // When the test was completed
  createdAt      DateTime  @default(now())

  // Relations
  user             User              @relation(fields: [userId], references: [id])
  test             Test?             @relation(fields: [testId], references: [id])
  questionAttempts QuestionAttempt[]

  @@map("test_attempts")
}

model QuestionAttempt {
  id             String   @id @default(cuid())
  testAttemptId  String
  questionId     String
  selectedOption Int
  isCorrect      Boolean
  timeSpent      Int? // Time spent on this question in seconds
  createdAt      DateTime @default(now())

  // Relations
  testAttempt TestAttempt @relation(fields: [testAttemptId], references: [id])
  question    Question    @relation(fields: [questionId], references: [id])

  @@map("question_attempts")
}

model StudyPlan {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  subjects    String // JSON array of subjects
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("study_plans")
}

model CalendarEvent {
  id            String   @id @default(cuid())
  userId        String
  title         String
  description   String?
  startTime     DateTime
  endTime       DateTime
  type          String // study, test, discussion, mock-exam
  weekNumber    Int?
  lecture       Int?
  subjects      String? // JSON array of subjects
  googleEventId String? // For Google Calendar sync
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("calendar_events")
}

model Concept {
  id          String   @id @default(cuid())
  name        String
  subject     String
  topic       String? // e.g., "DSM-5_Criteria", "Piaget_Stages"
  description String?
  difficulty  String   @default("medium") // easy, medium, hard
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  masteryRecords   ConceptMastery[]
  questionConcepts QuestionConcept[]

  @@unique([name, subject])
  @@map("concepts")
}

model QuestionConcept {
  id         String @id @default(cuid())
  questionId String
  conceptId  String
  weight     Float  @default(1.0) // How much this concept contributes to the question

  // Relations
  question Question @relation(fields: [questionId], references: [id])
  concept  Concept  @relation(fields: [conceptId], references: [id])

  @@unique([questionId, conceptId])
  @@map("question_concepts")
}

model ConceptMastery {
  id              String    @id @default(cuid())
  userId          String
  conceptId       String
  masteryLevel    Float     @default(0.0) // 0.0 to 1.0 (probability of mastery)
  attempts        Int       @default(0)
  correctAttempts Int       @default(0)
  lastReviewed    DateTime?
  nextReviewDate  DateTime? // For spaced repetition
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  concept Concept @relation(fields: [conceptId], references: [id])

  @@unique([userId, conceptId])
  @@index([userId])
  @@index([nextReviewDate])
  @@map("concept_mastery")
}

model AtRiskAlert {
  id              String    @id @default(cuid())
  userId          String
  riskLevel       String // low, medium, high, critical
  riskScore       Float // 0.0 to 1.0
  predictedScore  Float? // Predicted final score
  weeksUntilExam  Int?
  reasons         String // JSON array of risk factors
  recommendations String // JSON array of recommended actions
  isResolved      Boolean   @default(false)
  resolvedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([riskLevel])
  @@index([isResolved])
  @@map("at_risk_alerts")
}
